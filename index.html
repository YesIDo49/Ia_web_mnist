<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Est ce que l'IA sait lire ?</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.min.js"></script>
    <style>
        canvas {
            border: 1px solid red;
            background-color: black;
        }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .controls {
            margin: 20px 0;
        }
        h1, h2 {
            color: #333;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #feedback {
            margin-top: 10px;
            font-size: 16px;
            font-style: italic;
            color: #555;
        }
        #correctBtn, #incorrectBtn {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Est ce que l'IA sait lire ?</h1>
    <canvas id="canvas" width="280" height="280"></canvas>
    <div class="controls">
        <button onclick="clearCanvas()">Effacer</button>
        <button onclick="predict()">Pr√©dire</button>
        <br>
        <button id="correctBtn" onclick="confirmCorrect()">Correct</button>
        <button id="incorrectBtn" onclick="confirmIncorrect()">Incorrect</button>
    </div>
    <h2>Pr√©diction: <span id="prediction">Dessinez un chiffre ! (√† l'am√©ricaine)</span></h2>
    <div id="feedback"></div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const feedback = document.getElementById('feedback');
        const correctBtn = document.getElementById('correctBtn');
        const incorrectBtn = document.getElementById('incorrectBtn');
        let isDrawing = false;
        let session = null;

        const correctMessages = [
            "I.A. : Intelligente et Artificielle en bas !",
            "GPT approved ‚úîÔ∏è",
            "Almost sentient üëÄ",
            "slAI üíÖ",
            "Bient√¥t Akinator level",
            "Je broie la langue de MNIST",
        ];
        const incorrectMessages = [
            "Detroit did not become human...",
            "L'IA s'est pas tromp√©e, tu sais juste pas dessiner üëÄ",
            "Un dessin euuh vreumant",
            "Erreur 404 : Chiffre non reconnu !",
            "Ah la pr√©diction n'√©tait pas correcte ! T'es pas menteuse toi ?",
            "Try again, human.",
            "T'as essay√© d'√©teindre et de rallumer ?",
        ];

        ctx.lineWidth = 15;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'white';

        async function initSession() {
            try {
                session = await ort.InferenceSession.create('./mnist_model.onnx');
                console.log('ONNX session initialized successfully');
            } catch (e) {
                console.error('Error initializing ONNX session:', e);
                document.getElementById('prediction').textContent = 'Error loading model';
            }
        }

        initSession();

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('mousemove', draw);

        function startDrawing(event) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(event) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            document.getElementById('prediction').textContent = 'Dessinez un chiffre ! (√† l\'am√©ricaine)';
            feedback.textContent = '';
            correctBtn.style.display = 'none';
            incorrectBtn.style.display = 'none';
        }

        function confirmCorrect() {
            const prediction = document.getElementById('prediction').textContent;
            if (prediction === 'Dessinez un chiffre ! (√† l\'am√©ricaine)' || prediction === 'Mod√®le non charg√©' || prediction === 'Error in prediction') {
                feedback.textContent = 'Veuillez d\'abord faire une pr√©diction !';
            } else {
                const randomIndex = Math.floor(Math.random() * correctMessages.length);
                feedback.textContent = correctMessages[randomIndex];
            }
        }

        function confirmIncorrect() {
            const prediction = document.getElementById('prediction').textContent;
            if (prediction === 'Dessinez un chiffre ! (√† l\'am√©ricaine)' || prediction === 'Mod√®le non charg√©' || prediction === 'Error in prediction') {
                feedback.textContent = 'Veuillez d\'abord faire une pr√©diction !';
            } else {
                const randomIndex = Math.floor(Math.random() * incorrectMessages.length);
                feedback.textContent = incorrectMessages[randomIndex];
            }
        }

        async function predict() {
            if (!session) {
                document.getElementById('prediction').textContent = 'Mod√®le non charg√©';
                return;
            }

            feedback.textContent = '';
            correctBtn.style.display = 'none';
            incorrectBtn.style.display = 'none';

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 28;
            tempCanvas.height = 28;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, 28, 28);
            document.body.appendChild(tempCanvas);
            setTimeout(() => document.body.removeChild(tempCanvas), 2000);
            
            const imageData = tempCtx.getImageData(0, 0, 28, 28);
            const data = new Float32Array(1 * 1 * 28 * 28);
            for (let i = 0; i < imageData.data.length; i += 4) {
                const avg = (imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2]) / 3;
                data[i / 4] = (avg / 255.0 - 0.1307) / 0.3081;
            }

            console.log('Input tensor (first 50 values):', Array.from(data).slice(0, 50));

            const tensor = new ort.Tensor('float32', data, [1, 1, 28, 28]);

            try {
                const feeds = { input: tensor };
                const results = await session.run(feeds);
                const output = results.output.data;
                
                console.log('Model output:', Array.from(output));

                let maxProb = -Infinity;
                let prediction = 0;
                for (let i = 0; i < output.length; i++) {
                    if (output[i] > maxProb) {
                        maxProb = output[i];
                        prediction = i;
                    }
                }
                
                document.getElementById('prediction').textContent = prediction;
                correctBtn.style.display = 'inline-block';
                incorrectBtn.style.display = 'inline-block';
            } catch (e) {
                console.error('Error running inference:', e);
                document.getElementById('prediction').textContent = 'Error in prediction';
            }
        }
    </script>
</body>
</html>